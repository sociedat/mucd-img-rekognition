---
title: "Análisis de imagenes de redes sociales de agencias de seguridad mexicanas"
author: México Unido Contra la Delincuencia + SocialTIC + Sociedad Mexicana de Ciencia
  de Datos
date: "14/4/2021"
output: rmdformats::readthedown
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(readr)
library(plotly)
```

# Qué queremos lograr con este estudio?

TBD

# Preparación de datos

A continuación el proceso paso a paso

## Descargamos 1348 imagenes de la página de Facebook de la Secretaría de Marina de México junto con sus metadatos de la red social.

La descarga fue manual siguiendo los URLs de la siguiente tabla, donde se encuentran los metadatos como:

1. número de likes
2. número de shares
3. número de reacciones adicionales
4. comentario adjunto al post

```{r fb-table, echo=F, warning=F, message=F}
fb_export_semar <- read_csv('./fb-search-csv-export-sedena.csv') # dice SEDENA, pero es realmente SEMAR
fb_export_semar <- fb_export_semar %>% select(-c(1,3,4,5,17,18,19,20,21,25,26,27,28,29,30,31,32,33)) %>% mutate(id = 1:n()) %>% select(id, everything())
fb_export_semar %>% paged_table()
```

## Analizamos cada una con los algoritmos de clasificación de escena de Amazon Rekognition

![](https://i.imgur.com/ahUCu3z.png)

## Obtenemos de ese servicio una lista de etiquetas detectadas por el servicio de Rekognition junto con el % de confianza

```{r confidence-table, echo=F, warning=F, message=F}
rekognition_result <- read_csv('./fb_scores.csv') %>% mutate(Name = as.factor(Name))
rekognition_result %>% paged_table()
```
## Particionamos la lista de etiquetas en 4 áreas de interés:

1. **Etiquetas del ámbito militar:** 'destroyer','boat','soldier','frigate', etc.
2. **Etiquetas que describen armamento antipersonal:** 'weapon', 'firearm', 'swat team', etc.
3. **Etiauetas del ámbito social y de asistencia:** 'food','first aid','rural', etc.
4. **Etiquetas generales:** 'sunglasses','bird','building', etc.

> **IMPORTANTE:** Una imagen puede tener `N` etiquetas, por lo que una misma img puede estar repetida en más de 1 grupo.


### Diccionario de etiquetas militares:
```{r military-dict, echo=F, warning=F, message=F}
military_dict <- read_lines('military_labels.txt')
military_dict
```

### Diccionario de etiquetas del ámbito social
```{r social-dict, echo=F, warning=F, message=F}
social_dict <- read_csv('non_military_labels.txt')
social_dict$etiqueta
```

### Diccionario de etiquetas generales
```{r general-dict, echo=F, warning=F, message=F}
general_labels <- rekognition_result %>% filter(!(Name %in% military_dict) & !(Name %in% social_dict$etiqueta))
unique(general_labels$Name)
```

## Filtrado de temáticas con diccionario
```{r filtered-with-dict, echo=F, warning=F, message=F}
rekognition_filtered_w_dict <- rekognition_result %>% filter(Name %in% military_dict)
rekognition_filtered_w_dict %>% paged_table()
```


## Definimos un umbral de confianza para deducir ocurrencia de temas militares del 70%
```{r filtered-confidence-table, echo=F, warning=F, message=F}
param <- 70
rekognition_filtered_with_threshold <- rekognition_filtered_w_dict %>% filter(Confidence >= param) 
rekognition_filtered_with_threshold %>% paged_table()
```


## Unimos estos datos de _ocurrencia_ de temáticas militares con metadatos de reacciones sociales
```{r join-with-fb-metadata, echo=F, warning=F, message=F}
all_fb_semar <- rekognition_filtered_with_threshold %>% 
  inner_join(fb_export_semar, by = c('Source' = 'id')) %>%
  select(-c('User Name','Type','URL','Link','Message'))
all_fb_semar %>% paged_table()
```

# Preguntas de investigación

## Cuántas imagenes quedaron fuera una vez aplicados los filtros de confianza >= 70% y el filtro de diccionario de etiquetas militares?
```{r imgs-left-out, echo=F, warning=F, message=F}
left_out <- length(unique(rekognition_filtered_with_threshold$Source)) / length(unique(rekognition_result$Source)) * 100
paste0(round(left_out,2),' %')
```
## Qué etiquetas estaban sobrerepresentadas en las imgs que quedaron fuera?

Para este resultado, presentaremos las etiquetas detectadas que NO pertenecen al diccionario de palabras relacionadas a la milicia, y además eliminaremos aquellas categorías que solo estén representadas en 10 fotografias por considerarlas de poca densidad y por tanto de poca relevancia:
```{r categories-left-out, echo=F, warning=F, message=F}
rekognition_leftout_w_dict <- rekognition_result %>% filter(!(Name %in% military_dict))
rekognition_leftout_sum <- rekognition_leftout_w_dict %>% 
  group_by(Name) %>% 
  summarise(promedio_confianza = mean(Confidence, na.rm=T), conteo = n(), ponderado = (promedio_confianza * conteo)) %>% 
  filter(conteo >= 10) %>% 
  arrange(desc(ponderado))
rekognition_leftout_sum %>% paged_table()
```

Adicionalmente, vamos a eliminar las siguientes etiquetas por ser demasisado generales y poco relacionadas con el objetivo de investigación:

```{r general-dict, echo=F, warning=F, message=F}
general_dict <- read_lines('general_labels.txt')
general_dict
```

Excluyendo estas etiquetas, nos queda la siguiente representación:

```{r filtered-left-out, echo=F, warning=F, message=F}
rekognition_leftout_sum <- rekognition_leftout_sum %>% filter(!(Name %in% general_dict))
rekognition_leftout_sum %>% paged_table()
```


### Dato curioso

Hemos eliminado la etiqueta `Paintball` porque las imagenes que tienen asignada esta etiqueta son de este tipo:

![](https://i.imgur.com/rermiBQ.png)

Lo cual definitivamente no es correcto.

## Qué etiquetas están relacionadas con una percepción positiva de la SEMAR ante la sociedad y con qué frecuencia aparecen?

Para esta pregunta definiremos las siguientes categorías:

1. acercamiento con la sociedad civil
2. acciones de rescate y manejo de desastres
3. asistencia en campañas de salud
4. Proyección de imagen positiva
5. Proyección de imagen patriótica
6. Inclusión y género

Luego tomaremos armaremos 3 diccionarios con las etiquetas que creemos que están relacionadas con cada una, **sin repetir etiquetas en diferentes categorías**

```{r categories, echo=F, warning=F, message=F}
categories_labels <- read_csv('non_military_labels.txt')
categories_labels %>% arrange(categoria) %>% paged_table()
```

Una vez obtenidas estas categorías, podemos asociar cada una con las imgs descargadas y analizar distribuciones y concentraciones:

```{r categories-and-photos, echo=F, warning=F, message=F}
photos_categories_social <- rekognition_result %>% 
  rename(etiqueta = Name, confianza_etiqueta = Confidence, num_foto = Source) %>%
  inner_join(categories_labels) %>%
  filter(confianza_etiqueta >= param) %>%
  inner_join(fb_export_semar, by = c('num_foto' = 'id')) %>%
  select(-c('User Name','Type','URL','Link'))
summary_photos_social <- photos_categories_social %>% 
  group_by(categoria) %>% 
  summarise(confianza_promedio = mean(confianza_etiqueta, na.rm=T), num_fotos = n(), promedio_likes = mean(Likes, na.rm=T), 
            promedio_comments = mean(Comments, na.rm=T), 
            promedio_shares = mean(Shares, na.rm=T), 
            promedio_love = mean(Love, na.rm=T), 
            promedio_wow = mean(Wow, na.rm=T), 
            promedio_haha = mean(Haha, na.rm=T), 
            promedio_sad = mean(Sad, na.rm=T), 
            promedio_angry = mean(Angry, na.rm=T), 
            promedio_care = mean(Care, na.rm=T))
summary_photos_social %>% paged_table()
```

Con esto podemos observar lo siguiente **de este universo de fotografías**:

1. Hay considerablemente más fotos de **proyección positiva** que del resto de las categorías. La suma de las fotos de las otras categorías apenas suman 540, mientras que las de proyección positiva son 515, aproximadamente un **48.8%** del total.
2. Las fotografías de **proyección patriótica** concentra el **31.5%** del total de likes, y es 1.33 veces más que la 2a más concentrada de "acercamiento con civiles"
3. La reacción negativa _Angry_ tiene muy poca representación. Ninguna de las categorías llega a tener 1 reacción en promedio.
4. La reacción _Sad_ podemos intuir que llama a la simpatía y está concentrada en las categorías "Acercamiento con civiles", "Proyección patriótia" y "Proyección positiva".
5. Las fotografías en la categoría de **inclusión y género** representan apenas **0.6%** de este universo, y concentran el menor número de reacciones de todos los tipos.

Cuando comparamos esta distribución con las fotografías de claro corte militar, podemos ver lo siguiente:

```{r categories-and-photos-military, echo=F, warning=F, message=F}
all_fb_semar_summarised <- all_fb_semar %>% 
  group_by(Name) %>%
  summarise(num_fotos = n(),
            confianza_promedio = mean(Confidence, na.rm=T),
            promedio_likes = mean(Likes, na.rm=T), 
            promedio_comments = mean(Comments, na.rm=T), 
            promedio_shares = mean(Shares, na.rm=T), 
            promedio_love = mean(Love, na.rm=T), 
            promedio_wow = mean(Wow, na.rm=T), 
            promedio_haha = mean(Haha, na.rm=T), 
            promedio_sad = mean(Sad, na.rm=T), 
            promedio_angry = mean(Angry, na.rm=T), 
            promedio_care = mean(Care, na.rm=T)
            ) %>%
  arrange(desc(promedio_likes))
all_fb_semar_summarised %>% paged_table()
```

1. Aún cuando solamente hay 1 foto con una tanqueta, es la foto con mayor número de _likes_.
2. Aunque solamente hay 430 Fotos de equipamiento y armamento, éstas concentra alrededor de **23,000** reacciones de usuarios.
3. 


## Cómo se relacionan la cantidad de reacciones en eventos específicos?

TBD

## Líneas de investigación que requieren de mayor elaboración
1. **Capacidad de armamento:** Filtrar las imgs que son exclusivamente de uso de armamento antipersonal.
2. **Análisis de sentimiento de comentarios hechos a fotografías:** de momento no tenemos disponibles dichos comentarios.